<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  
  <title>KHT ë“œë¼ë§ˆ&ì—­ì‚¬ ì´ì•¼ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <!-- Kakao SDK: services ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ (ì§€ì˜¤ì½”ë”) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4bb276d241fb320936df581512dc8f62&autoload=false&libraries=services"></script>

  <!-- OpenLayers & proj4 -->
  <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
  <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.1/proj4.min.js"></script>

  <style>
    html, body { height:100%; margin:0; }
    #wrap { position:relative; width:100%; height:100%; }
    #kmap {
      position: absolute;
      inset: 0;
      z-index: 0;
    }

    #ol-layer {
      position: absolute;
      inset: 0;
      z-index: 99999;
      background: transparent;
      pointer-events: none;
      display: block;
    }
    .toolbar{
      position:absolute; top:12px; right:12px; z-index:100000;
      background:rgba(15,17,32,.88); color:#fff; border-radius:12px; padding:10px 12px;
      box-shadow:0 10px 24px rgba(0,0,0,.28);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR";
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .toolbar button{
      border:0; border-radius:10px; padding:8px 12px; cursor:pointer;
      background:#5b9cff; color:#fff; font-weight:700;
    }
    .toolbar button[data-on="1"]{ background:#22c55e; }
    .toolbar label{ display:flex; align-items:center; gap:6px; font-weight:600; }
    .toolbar input[type="range"]{ width:120px; }
    .note{ opacity:.8; }
    .seg { display:flex; gap:6px; background:rgba(255,255,255,.06); border-radius:9px; padding:3px; }
    .seg button{ background:transparent; border:1px solid rgba(255,255,255,.18); color:#fff; }
    .seg button.active{ background:#22c55e; border-color:#22c55e; color:#fff; }

    /* ===== ì—°ëŒ€í‘œ(FAB + íŒ¨ë„) ===== */
    .fab {
      position:absolute; right:16px; bottom:16px; z-index:100000;
      background:#111827; color:#fff; border-radius:999px; padding:10px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.3); cursor:pointer; user-select:none;
      font:14px/1 system-ui,"Noto Sans KR"; border:1px solid rgba(255,255,255,.15);
    }
    .timeline-panel{
      position:absolute; right:16px; bottom:64px; z-index:100000;
      width:min(1200px, 98vw);
      max-width:98vw;
      background:rgba(17,24,39,.94); color:#fff; border-radius:14px; padding:16px 18px 14px;
      box-shadow:0 12px 28px rgba(0,0,0,.32); backdrop-filter: blur(6px);
      display:none;
    }
    .timeline-header{
      display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px;
      font:14px/1.2 system-ui,"Noto Sans KR"; opacity:.95;
    }
    .timeline-bar{
      position:relative; width:100%; height:52px;
      border-radius:12px; overflow:hidden;
      background:rgba(255,255,255,.08);
      cursor:pointer;
      user-select:none;
    }
    .period{
      position:absolute; top:0; bottom:0;
      display:flex; align-items:center; justify-content:center;
      padding:0 10px;
      font-size:15px; line-height:1.2;
      text-align:center; white-space:normal;
      border-right:1px solid rgba(0,0,0,.15);
      color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.45);
      z-index:1;
    }
    .period span{ display:block; overflow:hidden; }
    .ticks{
      position:relative; height:24px; margin-top:8px;
    }
    .ticks .tick{
      position:absolute; top:0; width:1px; height:100%; background:rgba(255,255,255,.25);
    }
    .ticks .tick-label{
      position:absolute; top:12px; transform:translateX(-50%); font-size:12px; opacity:.85;
      cursor:pointer;
    }
    .close-x{
      cursor:pointer; border:0; background:transparent; color:#fff; opacity:.8; font-weight:700;
    }
    .tooltip{
      position:absolute; background:#111827; color:#fff; border:1px solid rgba(255,255,255,.15);
      padding:1px 8px; font-size:12px; border-radius:8px; pointer-events:none;
      transform:translate(-40%, -8px); white-space:nowrap; display:none;
      z-index: 1;
    }

    /* í´ë¦­ ì—°ë„ ì»¤ì„œ(ì„¸ë¡œì„ /ë°°ì§€/í•¸ë“¤) */
    .year-cursor{
      position:absolute; top:-6px; bottom:-6px; width:2px; background:#10b981;
      box-shadow:0 0 0 2px rgba(16,185,129,.25);
      border-radius:2px; pointer-events:none; z-index:10;
    }
    .year-badge{
      position:absolute; top:-26px; transform:translateX(-50%);
      background:#10b981; color:#081315; font-weight:700; font-size:12px;
      padding:3px 6px; border-radius:6px; white-space:nowrap;
      box-shadow:0 4px 10px rgba(0,0,0,.25); pointer-events:none; z-index:10;
    }
    .year-handle{
      position:absolute; top:6px; bottom:6px; left:0; transform:translateX(-50%);
      min-width:64px; padding:0 10px; border-radius:8px; border:1px solid rgba(255,255,255,.35);
      background:rgba(255,255,255,.25); backdrop-filter: blur(2px);
      display:none; align-items:center; justify-content:center; pointer-events:none; z-index:10;
    }
    .year-handle .txt{
      font-weight:800; font-size:16px; color:#0b1220; text-shadow:0 1px 0 rgba(255,255,255,.5);
    }

    /* ===== ì¢Œì¸¡ ìƒì„¸ íŒ¨ë„ ===== */
    .side-panel{
      position:absolute;
      left:0; top:0; bottom:0;
      width:320px;
      max-width:80vw;
      background:rgba(17,24,39,.94);
      color:#fff;
      border-right:1px solid rgba(255,255,255,.08);
      box-shadow:0 20px 40px rgba(0,0,0,.6);
      backdrop-filter:blur(8px);
      z-index:100001;
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR";
      transform:translateX(-100%);
      transition:transform .22s cubic-bezier(.4,0,.2,1);
      overflow-y: auto;
      overscroll-behavior: contain;
      display:flex;
      flex-direction:column;
    }
    .side-panel.open{
      transform:translateX(0);
    }

    .panel-head{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:16px 16px 12px;
    }

    .panel-thumb img{
      width:96px;
      height:128px;
      object-fit:cover;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.2);
      box-shadow:0 12px 24px rgba(0,0,0,.6);
      background:#1f2937;
    }

    .panel-meta{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .panel-meta h2{
      font-size:15px;
      font-weight:700;
      line-height:1.3;
      color:#fff;
      margin:0;
      word-break:keep-all;
    }
    .panel-sub{
      font-size:12px;
      line-height:1.4;
      color:#9ca3af;
      word-break:keep-all;
      white-space:normal;
    }

    .panel-close{
      position:absolute;
      right:8px;
      top:8px;
      background:transparent;
      border:0;
      color:#fff;
      opacity:.6;
      font-size:16px;
      font-weight:600;
      line-height:1;
      cursor:pointer;
      padding:4px;
    }
    .panel-close:hover{ opacity:1; }

    .panel-row{
      padding:10px 16px 12px;
      border-top:1px solid rgba(255,255,255,.07);
    }

    .panel-head{
      flex-shrink:0;
    }

    .panel-scroll{
      flex:1;
      min-height:0;
      overflow-y:auto;
      border-top:1px solid rgba(255,255,255,.07);
    }
    .row-label{
      font-size:11px;
      font-weight:600;
      line-height:1.3;
      letter-spacing:-.02em;
      color:#9ca3af;
      text-transform:uppercase;
      margin-bottom:2px;
    }
    .row-value{
      font-size:13px;
      line-height:1.4;
      word-break:keep-all;
      white-space:normal;
      color:#fff;
    }

    @media(max-width:720px){
    .timeline-panel{
        width:min(300px, 98vw);
      }
    }
    /* ===== ì£¼ë³€ ê´€ê´‘/ìˆ™ë°•/ìŒì‹ ì„¹ì…˜ ===== */
    .near-block {
      margin-top:10px;
    }
    .near-block:first-child {
      margin-top:0;
    }
    .near-head {
      font-size:12px;
      font-weight:600;
      line-height:1.4;
      color:#60a5fa;
      margin-bottom:4px;
    }

    .near-list {
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .near-li .near-title {
      font-size:13px;
      font-weight:600;
      line-height:1.4;
      color:#fff;
      word-break:keep-all;
    }
    .near-li .near-addr {
      font-size:12px;
      line-height:1.4;
      color:#9ca3af;
      word-break:keep-all;
      white-space:normal;
    }
    .near-item.active {
      background:rgba(96,165,250,.12); /* íŒŒë€ë¹› í•˜ì´ë¼ì´íŠ¸ */
      border-radius:6px;
    }
  </style>
  
</head>
<body>
  <div id="wrap">
    <div id="kmap"></div>

    <!-- ì™¼ìª½ ìƒì„¸ íŒ¨ë„ -->
    <div id="sidePanel" class="side-panel">
      <div class="panel-head">
        <div class="panel-thumb">
          <img id="pImg" src="" alt="" />
        </div>
        <div class="panel-meta">
          <h2 id="pTitle"></h2>
          <div id="pYearPlace" class="panel-sub"></div>
        </div>
        <button id="panelClose" class="panel-close">âœ•</button>
      </div>
      <div class="panel-scroll">
        <div class="panel-row">
          <div class="row-label">ì¥ì†Œ</div>
          <div class="row-value" id="pPlace"></div>
        </div>

        <div class="panel-row">
          <div class="row-label">ì£¼ì†Œ</div>
          <!-- ì´ div ì•ˆì— ê¸°ë³¸ ADDR + (ìˆìœ¼ë©´) CSVì—ì„œ ì°¾ì€ adr ë‘˜ ë‹¤ ë„£ì„ ê±°ë¼ innerHTMLë¡œ ì±„ìš¸ ì˜ˆì • -->
          <div class="row-value" id="pAddr"></div>
        </div>

        <div class="panel-row">
          <div class="row-label">ê´€ë ¨ ì •ë³´</div>
          <div class="row-value" id="pName"></div>
        </div>

        <div class="panel-row">
          <div class="row-label">ì„¤ëª…</div>
          <div class="row-value" id="pExp"></div>
        </div>

        <div class="panel-row">
          <div class="row-label">ì¶œì²˜</div>
          <div class="row-value" id="pRef"></div>
        </div>

        <div class="panel-row" id="pAroundRow" style="display:none;">
          <div class="row-label">ì£¼ë³€</div>
          <div class="row-value" id="pAround">
            <div class="near-block">
              <div class="near-head">ê´€ê´‘ì§€</div>
              <ul class="near-list" id="nearAtList">
                <!-- ë¡œë”©/ê²°ê³¼ê°€ JSì—ì„œ ë“¤ì–´ì˜´ -->
              </ul>
            </div>

            <div class="near-block">
              <div class="near-head">ìˆ™ì†Œ</div>
              <ul class="near-list" id="nearHoList"></ul>
            </div>

            <div class="near-block">
              <div class="near-head">ìŒì‹</div>
              <ul class="near-list" id="nearFdList"></ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- íˆ´ë°” -->
    <div class="toolbar">
      <button id="btnToggle" data-on="0">ê³¼ê±°ì§€ë„ ì¼œê¸°</button>

      <div class="seg">
        <button id="btn1919" class="active" data-year="1919">1919</button>
        <button id="btn1970" data-year="1970">1970</button>
      </div>

      <label>ë¶ˆíˆ¬ëª…
        <input id="opacity" type="range" min="0" max="1" step="0.05" value="0.1">
      </label>

      <span class="note">â€» ë©€ë¦¬ ì¶•ì†Œ ì‹œ ìë™ í˜ì´ë“œ</span>
    </div>

    <!-- OL ë ˆì´ì–´ (ì˜› ì§€ë„) -->
    <div id="ol-layer" class="map"></div>

    <!-- ìš°í•˜ë‹¨ ì—°ëŒ€í‘œ í† ê¸€ & íŒ¨ë„ -->
    <div id="fabTimeline" class="fab">ì—°ëŒ€í‘œ</div>
    <div id="timelinePanel" class="timeline-panel">
      <div class="timeline-header">
        <div>ì˜ì¡° â†’ í˜„ëŒ€(ê³µí™”êµ­) í†µì¹˜ êµ¬ê°„</div>
        <button id="closeTimeline" class="close-x">âœ•</button>
      </div>
      <div class="timeline-bar" id="timelineBar"></div>
      <div class="ticks" id="timelineTicks"></div>
      <div class="tooltip" id="timelineTip"></div>
    </div>
  </div>
  <!-- ===== AI ì±—ë´‡ Floating Button & Panel ===== -->
  <div id="chatFab" style="
    position:absolute;
    right:100px;
    bottom:16px;
    z-index:100002;

    width: 35px;
    height:35px;
    border-radius:10px;

    background:#0f172a;
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 16px 32px rgba(0,0,0,.45);

    display:flex;
    align-items:center;
    justify-content:center;

    cursor:pointer;
    user-select:none;
    padding:0;
  ">
    <img src="/history/ai-bubble-rounded-badge.png"
        alt="AI ì±—ë´‡ (ê¶ê¸ˆí•œì ì„ ë¬¼ì–´ë³´ì„¸ìš”)"
        style="
          width:32px;
          height:32px;
          display:block;
        "/>
  </div>


  <div id="chatPanel" style="
    position:absolute;
    right:16px;
    bottom:180px;
    width:320px;
    max-width:80vw;
    max-height:50vh;
    display:none;
    flex-direction:column;
    background:rgba(17,24,39,.95);
    border:1px solid rgba(255,255,255,.15);
    border-radius:12px;
    box-shadow:0 20px 40px rgba(0,0,0,.6);
    backdrop-filter: blur(8px);
    color:#fff;
    font:13px/1.4 system-ui,'Noto Sans KR';
    z-index:100003;
  ">
    <div style="padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:space-between;">
      <div style="font-size:13px; font-weight:600;">AI ì±—ë´‡ (ê¶ê¸ˆí•œì ì„ ë¬¼ì–´ë´ìš”)</div>
      <button id="chatClose" style="background:transparent;border:0;color:#fff;font-size:14px;opacity:.6;cursor:pointer;">âœ•</button>
    </div>

    <div id="chatMessages" style="flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:8px;"></div>

    <div style="border-top:1px solid rgba(255,255,255,.08); padding:8px 10px; display:flex; gap:6px;">
      <input id="chatInput" type="text" placeholder="ë¬´ì—‡ì´ ê¶ê¸ˆí•´ìš”?" style="
        flex:1;
        background:#1f2937;
        border:1px solid rgba(255,255,255,.2);
        color:#fff;
        font-size:13px;
        line-height:1.4;
        border-radius:8px;
        padding:8px 10px;
        outline:none;
      "/>
      <button id="chatSend" style="
        background:#4f46e5;
        border:0;
        font-size:13px;
        font-weight:600;
        color:#fff;
        border-radius:8px;
        padding:8px 10px;
        cursor:pointer;
        white-space:nowrap;
      ">ë³´ë‚´ê¸°</button>
    </div>
  </div>

<script>
/** ===== ê¸°ë³¸ê°’ ===== */
const INIT_CENTER = { lat: 37.42433704094878, lng: 126.97975155175968 };
const INIT_LEVEL  = 12;

/* ì¹´ì¹´ì˜¤â†”OL ì¤Œ ê¸°ë³¸ ë³´ì • */
const Z_OFFSET = 1;

/* ì¹´ì¹´ì˜¤ê°€ ë„ˆë¬´ ë©€ë¦¬ ì¶•ì†Œë˜ë©´ ì—­ì‚¬ì§€ë„ë¥¼ í˜ì´ë“œ ì•„ì›ƒ */
const HIDE_START_LEVEL = 12;
const HIDE_END_LEVEL   = 13;

/* ë ˆë²¨ë³„ ì¶”ê°€ í™•ëŒ€(ì˜¤ë²„ì¤Œ) */
const OVERSTEP_BY_LEVEL = {1:1, 2:0.01, 3:0.01, 4:0.01};

/* ê¸°ë³¸ ìŠ¤ì¼€ì¼(ë°°ìˆ˜) â€” ì‚¬ìš©ì ë³´ì •ê°’ */
let SCALE = 75.8;

/* ì—°ë„ë³„ WMTS ì„¤ì • */
const YEAR_CONFIG = {
  "1919": {
    title: "HGIS 1919",
    layer: "history:map1919",
    extent: [815164.9555917948, 1455946.3608951417, 1220536.614974792, 2075064.925722272]
  },
  "1970": {
    title: "HGIS 1970",
    layer: "history:map1970",
    extent: [815164.9555917948, 1455946.3608951417, 1220536.614974792, 2075064.925722272]
  }
};

const gridNames = [ 'EPSG:5179:0','EPSG:5179:1','EPSG:5179:2','EPSG:5179:3','EPSG:5179:4','EPSG:5179:5','EPSG:5179:6','EPSG:5179:7','EPSG:5179:8','EPSG:5179:9','EPSG:5179:10','EPSG:5179:11','EPSG:5179:12' ];
const resolutions = [ 15636.779110998164, 7818.389555499082, 3909.194777749541, 1954.5973888747706, 977.2986944373853, 488.64934721869264, 244.32467360934632, 122.16233680467316, 61.08116840233658, 30.54058420116829, 15.270292100584145, 7.6351460502920725, 3.8175730251460362 ];
const extent5179 = [ -196258.92353469727, 1132702.6936850615, 2439704.8100087596, 2976231.299481734 ];
const HIST_API = "https://hgis.history.go.kr/openapi/get.do?apiKey=9fc2b3db-4b2b-4058-88f8-2c5052ca9753";

/* ====== ì—°ëŒ€í‘œ ë°ì´í„° (ì˜ì¡° â†’ 6ê³µí™”êµ­) ====== */
const NOW_YEAR = new Date().getFullYear();
const PERIODS = [
  { label:'ì˜ì¡°', start:1724, end:1776, color:'#60a5fa' },
  { label:'ì •ì¡°', start:1776, end:1800, color:'#3b82f6' },
  { label:'ìˆœì¡°', start:1800, end:1834, color:'#8b5cf6' },
  { label:'í—Œì¢…', start:1834, end:1849, color:'#a78bfa' },
  { label:'ì² ì¢…', start:1849, end:1863, color:'#22c55e' },
  { label:'ê³ ì¢…', start:1863, end:1907, color:'#16a34a' },
  { label:'ìˆœì¢…', start:1907, end:1910, color:'#84cc16' },
  { label:'ì¼ì œê°•ì ê¸°', start:1910, end:1945, color:'#f59e0b' },
  { label:'ë¯¸êµ°ì •', start:1945, end:1948, color:'#f97316' },
  { label:'ì œ1ê³µí™”êµ­', start:1948, end:1960, color:'#ef4444' },
  { label:'ì œ2ê³µí™”êµ­', start:1960, end:1961, color:'#f87171' },
  { label:'ì œ3ê³µí™”êµ­', start:1963, end:1972, color:'#fb7185' },
  { label:'ì œ4ê³µí™”êµ­', start:1972, end:1981, color:'#ec4899' },
  { label:'ì œ5ê³µí™”êµ­', start:1981, end:1988, color:'#d946ef' },
  { label:'ì œ6ê³µí™”êµ­', start:1988, end:NOW_YEAR, color:'#a855f7' }
];
const TL_START = 1724;
const TL_END   = NOW_YEAR;
const TL_SPAN  = TL_END - TL_START;

</script>

<script>
// ===== AI ì±—ë´‡ ìœ„ì ¯ =====
const chatFab       = document.getElementById('chatFab');
const chatPanel     = document.getElementById('chatPanel');
const chatClose     = document.getElementById('chatClose');
const chatMessages  = document.getElementById('chatMessages');
const chatInput     = document.getElementById('chatInput');
const chatSend      = document.getElementById('chatSend');
const API_BASE = "https://rag.magiclab.kr"; // â† FastAPIê°€ ë–  ìˆëŠ” ìª½
let poiMarkers = [];            // ë§ˆì»¤ ê°ì²´ ëª¨ìŒ (ì§€ìš¸ ë•Œ ì‚¬ìš©)
let markerById = {};            // poiId -> kakao.maps.Marker
let poiDataById = {};           // poiId -> { title, addr, lat, lng, tel, kind }
let activeInfoWindow = null;    // í˜„ì¬ ì—´ë¦° ì¸í¬ìœˆë„ìš° í•˜ë‚˜
let activePoiId = null;         // í˜„ì¬ ì„ íƒëœ poiId
let poiIdCounter = 0;           // ê³ ìœ  ID ë°œê¸‰ê¸°

// ì—´ê³  ë‹«ê¸°
chatFab.addEventListener('click', () => {
  chatPanel.style.display = (chatPanel.style.display === 'flex') ? 'none' : 'flex';
});
chatClose.addEventListener('click', () => {
  chatPanel.style.display = 'none';
});

// helper: ë©”ì‹œì§€ë¥¼ UIì— ì¶”ê°€
function pushChatBubble(sender, text){
  const bubble = document.createElement('div');
  bubble.style.maxWidth = '85%';
  bubble.style.borderRadius = '10px';
  bubble.style.padding = '8px 10px';
  bubble.style.whiteSpace = 'pre-wrap';
  bubble.style.wordBreak = 'break-word';
  bubble.style.fontSize = '13px';
  bubble.style.lineHeight = '1.4';

  if(sender === 'user'){
    bubble.style.alignSelf = 'flex-end';
    bubble.style.background = '#4f46e5';
    bubble.style.color = '#fff';
  } else {
    bubble.style.alignSelf = 'flex-start';
    bubble.style.background = '#374151';
    bubble.style.color = '#fff';
  }

  bubble.textContent = text;
  chatMessages.appendChild(bubble);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// í˜„ì¬ ì„ íƒëœ ì¥ì†Œ ì»¨í…ìŠ¤íŠ¸(ì‚¬ì´ë“œíŒ¨ë„ì˜ ë°ì´í„°)ë¥¼ ì±—ë´‡ì— ê°™ì´ ë„˜ê¸°ê³  ì‹¶ë‹¤ë©´
function getCurrentContextForAI(){
  // sidePanelì— í‘œì‹œëœ ì •ë³´ ê·¸ëŒ€ë¡œ ì½ì–´ì™€ì„œ contextë¡œ ì¤„ ìˆ˜ ìˆìŒ
  return {
    title: pTitle.textContent,
    year_place: pYearPlace.textContent,
    place: pPlace.textContent,
    addr: pAddr.textContent,
    name: pName.textContent,
    exp: pExp.textContent,
    ref: pRef.textContent
  };
}

// ì„œë²„ì— ì§ˆë¬¸ ë³´ë‚´ê¸°
async function sendChat(){
  const userText = chatInput.value.trim();
  if(!userText) return;

  // UIì— ì‚¬ìš©ì ë§í’ì„  ì°ê¸°
  pushChatBubble('user', userText);
  chatInput.value = '';

  // ì»¨í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì—†ì–´ë„ ë˜ì§€ë§Œ ìˆìœ¼ë©´ í›¨ì”¬ ë˜‘ë˜‘í•´ì§)
  const context = getCurrentContextForAI();

  // ì„œë²„ë¡œ fetch
  try {
    const resp = await fetch(`${API_BASE}/api/chatbot`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({
        question: userText,
        context: getCurrentContextForAI()  // ì‚¬ì´ë“œíŒ¨ë„ì—ì„œ ê¸ì–´ì˜¨ ì •ë³´
      })
    });

    const data = await resp.json();

    // data.answer ë¼ê³  ê°€ì •
    pushChatBubble('bot', data.answer || '(ì‘ë‹µ ì—†ìŒ)');
  } catch(err){
    console.error(err);
    pushChatBubble('bot', 'ì—ëŸ¬ê°€ ë°œìƒí–ˆì–´ìš” ğŸ˜¥');
  }
}

chatSend.addEventListener('click', sendChat);
chatInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){
    e.preventDefault();
    sendChat();
  }
});

function clearPoiMarkers() {
  poiMarkers.forEach(m => m.setMap(null));
  poiMarkers = [];

  markerById   = {};
  poiDataById  = {};

  if (activeInfoWindow) {
    activeInfoWindow.close();
    activeInfoWindow = null;
  }
  activePoiId = null;

  // íŒ¨ë„ ìª½ í•˜ì´ë¼ì´íŠ¸ë„ ì´ˆê¸°í™”í•´ë„ ë¨
  const wrap = document.getElementById('nearbyList');
  const lists = [nearAtList, nearHoList, nearFdList].filter(Boolean);
  lists.forEach(ul => {
    ul.querySelectorAll('.near-item.active').forEach(el => el.classList.remove('active'));
  });
}



window.addEventListener('DOMContentLoaded', () => {
  kakao.maps.load(() => {

    /* 1) ì¹´ì¹´ì˜¤ë§µ */
    const kmap = new kakao.maps.Map(document.getElementById('kmap'), {
      center: new kakao.maps.LatLng(INIT_CENTER.lat, INIT_CENTER.lng),
      level: INIT_LEVEL
    });

    /* 2) OpenLayers */
    proj4.defs("EPSG:5179", "+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.9996 +x_0=1000000 +y_0=2000000 +ellps=GRS80 +units=m +no_defs");
    const initCenter5179 = ol.proj.transform([INIT_CENTER.lng, INIT_CENTER.lat], "EPSG:4326", "EPSG:5179");
    const olView = new ol.View({
      extent: extent5179,
      projection: "EPSG:5179",
      center: initCenter5179,
      zoom: 13,
      minZoom: 0,
      maxZoom: 20,
      constrainResolution: false
    });
    const olMap = new ol.Map({
      target: 'ol-layer',
      layers: [],
      view: olView,
      controls: new ol.Collection(),
      interactions: new ol.Collection(),
      loadTilesWhileInteracting: true
    });
    const olHost     = document.getElementById('ol-layer');
    const olViewport = olMap.getViewport();
    olViewport.style.background = 'transparent';
    olViewport.style.pointerEvents = 'none';
    olViewport.style.zIndex = '99999';
    
    /* === ì—°ë„ë³„ ë ˆì´ì–´ ìƒì„±/ì „í™˜ === */
    function createHistLayer(cfg){
      const tileGrid = new ol.tilegrid.WMTS({
        tileSize: [256, 256],
        extent: cfg.extent,
        origin: [-200000.0, 4000000.0],
        resolutions, matrixIds: gridNames
      });
      const layer = new ol.layer.Tile({
        title: cfg.title,
        extent: cfg.extent,
        source: new ol.source.WMTS({
          url: HIST_API,
          layer: cfg.layer,
          matrixSet: "EPSG:5179",
          format: "image/png",
          projection: "EPSG:5179",
          tileGrid,
          wrapX: false,
          serverType: "geoserver"
        }),
        visible: true
      });
      return layer;
    }
    let histLayer = null;
    function setYear(year){
      const cfg = YEAR_CONFIG[year];
      if (!cfg) return;
      if (histLayer){ olMap.removeLayer(histLayer); histLayer = null; }
      histLayer = createHistLayer(cfg);
      olMap.getLayers().push(histLayer);
      applyZoomOutFade(kmap.getLevel());
      olMap.updateSize(); olMap.renderSync();
      // ë²„íŠ¼ ìƒíƒœ ë™ê¸°í™”
      document.getElementById('btn1919').classList.toggle('active', year==='1919');
      document.getElementById('btn1970').classList.toggle('active', year==='1970');
    }
    setYear('1919'); // ê¸°ë³¸

    /* 3) ë™ê¸°í™” + ì˜¤ë²„ì¤Œ + ì¤Œì•„ì›ƒ-í˜ì´ë“œ */
    function kakaoLevelToOlZoom(level){
      const table = {1:12,2:11,3:10,4:9,5:8,6:7,7:6,8:5,9:4,10:3,11:2,12:1,13:1,14:0};
      level = Math.max(1, Math.min(14, level|0));
      return Math.max(0, Math.min(12, table[level] + Z_OFFSET));
    }
    function applyZoomOutFade(level){
      const opCtl = document.getElementById('opacity');
      if (level >= HIDE_END_LEVEL) { olHost.style.opacity = '0'; return; }
      if (level <= HIDE_START_LEVEL) { olHost.style.opacity = String(opCtl.value); return; }
      const t = (level - HIDE_START_LEVEL) / (HIDE_END_LEVEL - HIDE_START_LEVEL);
      const base = parseFloat(opCtl.value);
      olHost.style.opacity = String((base * (1 - t)).toFixed(3));
    }
    let rafToken = null;
    function syncOLFromKakao(){
      if (rafToken) return;
      rafToken = requestAnimationFrame(() => {
        rafToken = null;
        const c  = kmap.getCenter();
        const lv = kmap.getLevel();
        applyZoomOutFade(lv);
        if (lv >= HIDE_END_LEVEL) return;

        const c5179 = ol.proj.transform([c.getLng(), c.getLat()], "EPSG:4326", "EPSG:5179");
        olView.setCenter(c5179);

        const baseZ   = kakaoLevelToOlZoom(lv);
        const baseRes = olView.getResolutionForZoom(baseZ);
        const extra   = OVERSTEP_BY_LEVEL[lv] || 0;
        const adjRes  = (baseRes / Math.pow(2, extra)) / SCALE;
        olView.setResolution(adjRes);
      });
    }
    kakao.maps.event.addListener(kmap, 'center_changed', syncOLFromKakao);
    kakao.maps.event.addListener(kmap, 'zoom_changed',   () => {
      olHost.style.visibility = 'hidden';
      syncOLFromKakao();
      olMap.updateSize();
      olMap.renderSync();
      olHost.style.visibility = 'visible';
    });
    kakao.maps.event.addListener(kmap, 'idle',           syncOLFromKakao);
    syncOLFromKakao();
    window.addEventListener('resize', () => { olMap.updateSize(); });

    /* 4) ë“œë˜ê·¸-íŒ”ë¡œìš° */
    const proj = kmap.getProjection();
    const ptFromLatLng = (ll) => proj.containerPointFromCoords(ll);
    let follow = { active:false, baseCenter:null, baseTransform:'' };
    kakao.maps.event.addListener(kmap, 'dragstart', () => {
      follow.active        = true;
      follow.baseCenter    = kmap.getCenter();
      follow.baseTransform = olViewport.style.transform || 'none';
      olViewport.style.willChange = 'transform';
    });
    kakao.maps.event.addListener(kmap, 'drag', () => {
      if (!follow.active) return;
      const p0 = ptFromLatLng(follow.baseCenter);
      const p1 = ptFromLatLng(kmap.getCenter());
      const dx = p0.x - p1.x;
      const dy = p0.y - p1.y;
      const base = (follow.baseTransform && follow.baseTransform !== 'none') ? follow.baseTransform : '';
      olViewport.style.transform = `${base} translate(${dx}px, ${dy}px)`;
    });
    kakao.maps.event.addListener(kmap, 'dragend', () => {
      follow.active = false;
      olViewport.style.transform = follow.baseTransform || 'none';
      olViewport.style.willChange = '';
      syncOLFromKakao();
      olMap.updateSize();
      olMap.renderSync();
    });

    /* 5) í† ê¸€/ë¶ˆíˆ¬ëª… + ì—°ë„ ì „í™˜ UI */
    const btnToggle = document.getElementById('btnToggle');
    const opacity   = document.getElementById('opacity');
    const btn1919   = document.getElementById('btn1919');
    const btn1970   = document.getElementById('btn1970');

    function showHistorical(){
      document.getElementById('ol-layer').style.display = 'block';
      syncOLFromKakao();
      olMap.updateSize();
      olMap.renderSync();
    }
    function hideHistorical(){
      document.getElementById('ol-layer').style.display = 'none';
    }
    btnToggle.addEventListener('click', () => {
      const on = btnToggle.getAttribute('data-on') === '1';
      if (on) {
        btnToggle.setAttribute('data-on','0');
        btnToggle.textContent = 'ê³¼ê±°ì§€ë„ ì¼œê¸°';
        hideHistorical();
      } else {
        btnToggle.setAttribute('data-on','1');
        btnToggle.textContent = 'ê³¼ê±°ì§€ë„ ë„ê¸°';
        showHistorical();
      }
    });
    opacity.addEventListener('input', () => applyZoomOutFade(kmap.getLevel()));
    function activateYearButton(activeBtn){
      [btn1919, btn1970].forEach(b => b.classList.toggle('active', b === activeBtn));
    }
    btn1919.addEventListener('click', () => { activateYearButton(btn1919); setYear('1919'); });
    btn1970.addEventListener('click', () => { activateYearButton(btn1970); setYear('1970'); });

    /* 6) === ë°ì´í„° ë¡œë“œìš© ì „ì—­ === */
    let HIST_POINTS = [];           // hist_points.json ë‚´ìš©
    const personAddrMap = {};       // { [name]: adr }  â† history_data.csvì—ì„œ ë§Œë“  ë§¤í•‘

    const geocoder = new kakao.maps.services.Geocoder();
    const geocodeCache = new Map(); // addr -> LatLng|null
    let markers = [];
    let geocodeQueue = [];
    let geocodeTimer = null;

    /* 6-1) hist_points.json ë¶ˆëŸ¬ì˜¤ê¸° */
    async function loadHistPoints() {
      try {
        const res = await fetch('hist_points.json', {cache: 'no-store'});
        HIST_POINTS = await res.json();
        console.log('[HIST] hist_points loaded', HIST_POINTS.length);
      } catch (e) {
        console.warn('[HIST] hist_points.json ë¡œë“œ ì‹¤íŒ¨:', e);
        HIST_POINTS = [];
      }
    }

    /* 6-2) history_data.csv ë¶ˆëŸ¬ì™€ì„œ name -> adr ë§¤í•‘ ë§Œë“¤ê¸°
       CSV ì˜ˆ: name,adr
              í™ê¸¸ë™,ì„œìš¸ ì–´ë””ì–´ë””...
    */
    async function loadPersonAddrCSV() {
      try {
        const res = await fetch('history_data.csv', {cache:'no-store'});
        const text = await res.text();

        // ê°„ë‹¨ íŒŒì„œ (ì²« ì¤„ í—¤ë”ë¼ê³  ê°€ì •)
        // ì¤„ ë‹¨ìœ„ split
        const lines = text
          .split(/\r?\n/)
          .map(l => l.trim())
          .filter(l => l.length > 0);

        if (lines.length < 2) {
          console.warn('[HIST] CSV ë¼ì¸ ìˆ˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');
          return;
        }

        // header íŒŒì‹±
        const header = lines[0].split(',');
        const nameIdx = header.findIndex(h => h.trim().toLowerCase() === 'name');
        const adrIdx  = header.findIndex(h => h.trim().toLowerCase() === 'adr');

        if (nameIdx === -1 || adrIdx === -1) {
          console.warn('[HIST] CSVì— name/adr í—¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤');
        }

        // ë³¸ë¬¸ íŒŒì‹±
        for (let i = 1; i < lines.length; i++){
          const cols = lines[i].split(',');
          const nm  = (cols[nameIdx] || '').trim();
          const adr = (cols[adrIdx]  || '').trim();
          if (nm) {
            // ê°™ì€ nameì´ ì—¬ëŸ¬ë²ˆ ìˆì„ ìˆ˜ ìˆì§€ë§Œ, ì¼ë‹¨ ë§ˆì§€ë§‰ ê²ƒì„ ìš°ì„ 
            personAddrMap[nm] = adr;
          }
        }

        console.log('[HIST] CSV loaded. personAddrMap size:', Object.keys(personAddrMap).length);
      } catch (e) {
        console.warn('[HIST] history_data.csv ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }

    // ===== ì´ë¯¸ì§€ ì‹¤ì œ í¬ê¸° ì½ì–´ì„œ ë¹„ìœ¨ ìœ ì§€í•œ ë§ˆì»¤ =====
    // function addMarker(latlng, data){
    //   const imageSrc = data.title ? `/history/${data.title}.jpg` : '/history/ê¸°ë³¸ì´ë¯¸ì§€.jpg';

    //   getImageSize(imageSrc).then(imageSize => {
    //     const maxWidth  = 200;
    //     const maxHeight = 200;
    //     const ratio     = Math.min(maxWidth / imageSize.width, maxHeight / imageSize.height);

    //     const imageWidth  = imageSize.width  * ratio;
    //     const imageHeight = imageSize.height * ratio;

    //     const imageOption = { offset: new kakao.maps.Point(imageWidth / 2, imageHeight) };
    //     const markerImage = new kakao.maps.MarkerImage(
    //       imageSrc,
    //       new kakao.maps.Size(imageWidth, imageHeight),
    //       imageOption
    //     );

    //     const marker = new kakao.maps.Marker({
    //       position: latlng,
    //       image: markerImage
    //     });

    //     marker.setMap(kmap);

    //     kakao.maps.event.addListener(marker, 'click', () => {
    //       openInfoPanel(data, imageSrc);
    //     });

    //     markers.push(marker);
    //   });
    // }

    function addMarker(latlng, data){
      const imageSrc = data.title ? `/history/${data.title}.jpg` : '/history/ê¸°ë³¸ì´ë¯¸ì§€.jpg';

      getImageSize(imageSrc).then(imageSize => {
        const maxWidth  = 200;
        const maxHeight = 200;
        const ratio     = Math.min(maxWidth / imageSize.width, maxHeight / imageSize.height);

        const imageWidth  = imageSize.width  * ratio;
        const imageHeight = imageSize.height * ratio;

        const imageOption = { offset: new kakao.maps.Point(imageWidth / 2, imageHeight) };
        const markerImage = new kakao.maps.MarkerImage(
          imageSrc,
          new kakao.maps.Size(imageWidth, imageHeight),
          imageOption
        );

        const marker = new kakao.maps.Marker({
          position: latlng,
          image: markerImage
        });

        marker.setMap(kmap);

        kakao.maps.event.addListener(marker, 'click', () => {
          // â˜… latlng ê°™ì´ ë„˜ê¸´ë‹¤
          openInfoPanel(data, imageSrc, latlng);
        });

        markers.push(marker);
      });
    }

    // ì§€ì˜¤ì½”ë”© í (ë‚¨ê²¨ë‘ )
    function geocodeAddr(addr, cb){
      if (geocodeCache.has(addr)) { cb(geocodeCache.get(addr)); return; }
      geocodeQueue.push({addr, cb});
      if (!geocodeTimer){
        geocodeTimer = setInterval(() => {
          const job = geocodeQueue.shift();
          if (!job){ clearInterval(geocodeTimer); geocodeTimer = null; return; }
          geocoder.addressSearch(job.addr, (result, status) => {
            if (status === kakao.maps.services.Status.OK && result[0]){
              const latlng = new kakao.maps.LatLng(result[0].y, result[0].x);
              geocodeCache.set(job.addr, latlng);
              job.cb(latlng);
            }else{
              console.warn('[HIST] ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨:', job.addr, status);
              geocodeCache.set(job.addr, null);
              job.cb(null);
            }
          });
        }, 180);
      }
    }

    // async function showPinsForYear(year) {
    //   clearMarkers();  // ê¸°ì¡´ ë§ˆì»¤ ì œê±°

    //   // ì—°ë„ í•„í„°
    //   const list = HIST_POINTS.filter(d => {
    //     // ì£¼ì†Œ ì—†ìœ¼ë©´ ìŠ¤í‚µ
    //     if (!d.ADDR && !d.addr) return false;

    //     // ìš°ì„  y1/y2 ìˆìœ¼ë©´ ê·¸ê±° ì‚¬ìš©
    //     let y1 = (d.y1 ?? d.y2);
    //     let y2 = (d.y2 ?? d.y1);

    //     // ì—†ìœ¼ë©´ DATA(ë¬¸ìì—´)ì—ì„œ ìˆ«ì ë½‘ê¸°
    //     if (y1 == null && y2 == null) {
    //       const parsed = parseInt(d.DATA || d.data || '', 10);
    //       if (!isNaN(parsed)) {
    //         y1 = parsed;
    //         y2 = parsed;
    //       }
    //     }
    //     if (y1 == null && y2 == null) return false;

    //     const minY = Math.min(y1, y2);
    //     const maxY = Math.max(y1, y2);
    //     return (minY <= year && year <= maxY);
    //   });

    //   const bounds = new kakao.maps.LatLngBounds();
    //   let anyMarker = false;

    //   await Promise.all(list.map(async (d) => {
    //     const addrText = d.ADDR || d.addr;
    //     const latlng = await getLatLng(addrText);
    //     if (latlng) {
    //       addMarker(latlng, d);
    //       bounds.extend(latlng);
    //       anyMarker = true;
    //     }
    //   }));

    //   if (anyMarker) {
    //     kmap.setBounds(bounds);
    //   }

    //   console.log(`[HIST] ${year}ë…„ í‘œì‹œ ê±´ìˆ˜: ${list.length}`);
    // }

    // ë§ˆì»¤ ì´ˆê¸°í™”
    
    async function showPinsForYear(year) {
      clearMarkers();  // ê¸°ì¡´ ë§ˆì»¤ ì œê±°

      // 1) í•´ë‹¹ ì—°ë„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ë§Œ
      const list = HIST_POINTS.filter(d => {
        if (!d.addr) return false;
        if (d.y1 == null && d.y2 == null) return false;
        const y1 = (d.y1 ?? d.y2);
        const y2 = (d.y2 ?? d.y1);
        return y1 <= year && year <= y2;
      });

      // 2) ëª¨ë“  ë°ì´í„°ì— ëŒ€í•´ ì§€ì˜¤ì½”ë”© ë¨¼ì €
      //    { data: d, latlng } í˜•íƒœ ë°°ì—´ ë§Œë“¤ê¸°
      const withCoords = [];
      await Promise.all(list.map(async (d) => {
        const latlng = await getLatLng(d.addr);
        if (latlng) {
          withCoords.push({ data: d, latlng });
        }
      }));

      // 3) ì¢Œí‘œë³„ë¡œ ê·¸ë£¹í•‘
      //    keyëŠ” "lat,lng" ë¬¸ìì—´ë¡œ(ì†Œìˆ˜ì  ì¤„ì—¬ì„œ ê°™ì€ ê³³ ì·¨ê¸‰)
      const groups = new Map();
      withCoords.forEach(item => {
        const lat = item.latlng.getLat().toFixed(6);
        const lng = item.latlng.getLng().toFixed(6);
        const key = lat + ',' + lng;
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(item);
      });

      // 4) ê° ê·¸ë£¹ì„ í¼ëœ¨ë¦¬ë©´ì„œ ë§ˆì»¤ ìƒì„±
      const bounds = new kakao.maps.LatLngBounds();

      groups.forEach((arr) => {
        const total = arr.length;

        arr.forEach((item, idx) => {
          const baseLatLng = item.latlng;
          const spreadPos  = spreadLatLng(baseLatLng, idx, total); // <- í•µì‹¬!
          addMarker(spreadPos, item.data);
          bounds.extend(spreadPos);
        });
      });

      // 5) boundsê°€ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ ì§€ë„ ë§ì¶”ê¸°
      if (!bounds.isEmpty && !bounds.isEmpty()) {
        kmap.setBounds(bounds);
      }

      console.log(`[HIST] ${year}ë…„ í‘œì‹œ ê±´ìˆ˜(ì¢Œí‘œ ì„±ê³µ): ${withCoords.length}`);
    }

    function clearMarkers() {
      markers.forEach(marker => {
        marker.setMap(null);
      });
      markers = [];
    }

    // ìœ í‹¸: ì´ë¯¸ì§€ í¬ê¸°
    function getImageSize(src) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          resolve({ width: img.width, height: img.height });
        };
        img.onerror = () => {
          console.warn('[HIST] ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨:', src);
          resolve({ width: 90, height: 120 }); // fallback
        };
        img.src = src;
      });
    }

    // ìœ í‹¸: ì£¼ì†Œ -> ì¢Œí‘œ
    function getLatLng(addr) {
      return new Promise((resolve) => {
        geocoder.addressSearch(addr, (result, status) => {
          if (status === kakao.maps.services.Status.OK && result[0]) {
            const latlng = new kakao.maps.LatLng(result[0].y, result[0].x);
            resolve(latlng);
          } else {
            console.warn('[HIST] ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨:', addr);
            resolve(null);
          }
        });
      });
    }
    
    function escapeHtml(str){
      return (str ?? "").toString()
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function renderNearList(targetUL, items, kind){
      if(!targetUL) return;

      if(!Array.isArray(items) || items.length === 0){
        targetUL.innerHTML = '<li class="near-li" style="opacity:.6;">ì£¼ë³€ ì •ë³´ ì—†ìŒ</li>';
        return;
      }

      // ìƒìœ„ 5ê°œë§Œ
      const slice = items.slice(0,5);

      targetUL.innerHTML = slice.map(it => {
        // poiId ì—†ìœ¼ë©´ ë¶€ì—¬ (ë¦¬ìŠ¤íŠ¸ì™€ ë§ˆì»¤ê°€ ê°™ì€ ê°ì²´ë¥¼ ê³µìœ í•˜ë‹ˆ, ì´í›„ addPoiMarkersê°€ ì´ poiIdë¥¼ ì¬ì‚¬ìš©)
        if(!it.poiId){
          it.poiId = 'poi_' + (poiIdCounter++);
        }
        it.kind = kind;
        poiDataById[it.poiId] = it;

        const t = escapeHtml(it.title || '');
        const a = escapeHtml(it.addr  || '');

        return `
          <button class="near-item"
                  data-poiid="${it.poiId}"
                  style="
                    display:block;
                    text-align:left;
                    width:100%;
                    background:transparent;
                    border:0;
                    padding:6px 0;
                    color:#fff;
                    cursor:pointer;
                  ">
            <div class="near-title">${t}</div>
            <div class="near-addr">${a}</div>
          </button>
        `;
      }).join('');

      // ìœ„ì„ í´ë¦­: ë²„íŠ¼ ëˆ„ë¥´ë©´ focusPoi
      targetUL.addEventListener('click', (e) => {
        const btn = e.target.closest('.near-item');
        if(!btn) return;
        const poiId = btn.dataset.poiid;
        if(!poiId) return;
        focusPoi(poiId, {centerMap:true, openInfo:true, highlightList:true});
      }, { once:false });
    }

    async function loadNearbyTourPreview(latlngHint, addrText){
      // íŒ¨ë„ ì œì¼ ì•„ë˜ ì„¹ì…˜ ë³´ì´ê²Œ
      pAroundRow.style.display = 'block';

      // ë¡œë”© í‘œì‹œ
      nearAtList.innerHTML = '<li class="near-li"><div class="near-title">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></li>';
      nearHoList.innerHTML = '<li class="near-li"><div class="near-title">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></li>';
      nearFdList.innerHTML = '<li class="near-li"><div class="near-title">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></li>';

      let baseLatLng = latlngHint;

      // ë§ˆì»¤ í´ë¦­ ì‹œ ì¢Œí‘œ(latlngHint) ì•ˆ ë„˜ì–´ì˜¨ ê²½ìš° â†’ ì£¼ì†Œë¡œ ì§€ì˜¤ì½”ë”©í•´ì„œ ê¸°ì¤€ì  í™•ë³´
      if(!baseLatLng){
        if(!addrText){
          nearAtList.innerHTML = '<li class="near-li" style="opacity:.6;">ì£¼ë³€ ì •ë³´ ì—†ìŒ</li>';
          nearHoList.innerHTML = '<li class="near-li" style="opacity:.6;">ì£¼ë³€ ì •ë³´ ì—†ìŒ</li>';
          nearFdList.innerHTML = '<li class="near-li" style="opacity:.6;">ì£¼ë³€ ì •ë³´ ì—†ìŒ</li>';
          return;
        }
        baseLatLng = await getLatLng(addrText);
      }

      if(!baseLatLng){
        nearAtList.innerHTML = '<li class="near-li" style="opacity:.6;">ì£¼ë³€ ì •ë³´ ì—†ìŒ</li>';
        nearHoList.innerHTML = '<li class="near-li" style="opacity:.6;">ì£¼ë³€ ì •ë³´ ì—†ìŒ</li>';
        nearFdList.innerHTML = '<li class="near-li" style="opacity:.6;">ì£¼ë³€ ì •ë³´ ì—†ìŒ</li>';
        return;
      }

      const lat = baseLatLng.getLat();
      const lng = baseLatLng.getLng();

      try{
        // contentTypeId: 12 ê´€ê´‘ì§€ / 32 ìˆ™ë°• / 39 ìŒì‹ì 
        const [attractions, hotels, foods] = await Promise.all([
          tourNearby(lat, lng, { radius: 2000, type: "12", max: 15 }),
          tourNearby(lat, lng, { radius: 2000, type: "32", max: 15 }),
          tourNearby(lat, lng, { radius: 2000, type: "39", max: 15 }),
        ]);


        // ì§€ë„ ë§ˆì»¤ ê°±ì‹ 
        clearPoiMarkers();

        addPoiMarkers(attractions, 'tour');
        addPoiMarkers(hotels,      'hotel');
        addPoiMarkers(foods,       'food');
        // íŒ¨ë„ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        renderNearList(nearAtList, attractions, 'tour');
        renderNearList(nearHoList, hotels,      'hotel');
        renderNearList(nearFdList, foods,       'food');

      }catch(err){
        console.error('[TourAPI] fetch fail', err);
        renderNearList(nearAtList, [], 'tour');
        renderNearList(nearHoList, [], 'hotel');
        renderNearList(nearFdList, [], 'food');
      }
    }

        // ì£¼ë³€ ê´€ê´‘/ìˆ™ì†Œ/ìŒì‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    // type: "12"(ê´€ê´‘), "32"(ìˆ™ì†Œ), "39"(ìŒì‹)  <- TourAPI contentTypeId
    async function tourNearby(lat, lng, { radius = 2000, type = "12", max = 5 } = {}){
      const url = API_BASE + "/api/tour/nearby?" + new URLSearchParams({
        lat,
        lng,
        radius,
        type,
        max
      });
      const r = await fetch(url);
      const j = await r.json();
      if(!j.ok){
        console.warn('[TourAPI] error', j);
        return [];
      }
      return j.items || [];
    }

    // baseLatLng ì£¼ë³€ìœ¼ë¡œ indexë²ˆì§¸ ë§ˆì»¤ë¥¼ ì›í˜•ìœ¼ë¡œ í¼ëœ¨ë ¤ì„œ ëŒë ¤ì¤€ë‹¤
    // index: 0,1,2,... / total: ê·¸ ì£¼ì†Œ(ë˜ëŠ” ì¢Œí‘œ)ì— ëª‡ ê°œì¸ì§€
    function spreadLatLng(baseLatLng, index, total){
      if (total === 1) return baseLatLng;

      // ì›ì˜ ë°˜ì§€ë¦„ (ë¯¸í„° ë‹¨ìœ„). ê°œìˆ˜ê°€ ë§ì„ìˆ˜ë¡ ì¡°ê¸ˆ ë” ë„“ê²Œ
      const radiusM = Math.min(30, 8 + total * 2); // ì ë‹¹íˆ 8m ~ 30m ì •ë„

      // ê°ë„: ì „ì²´ë¥¼ ê· ë“±ë¶„ë°°
      const angleRad = (2 * Math.PI * index) / total;

      // meter -> ìœ„/ê²½ë„ ë³´ì •
      const dx = radiusM * Math.cos(angleRad); // ë™ì„œ ë°©í–¥ (m)
      const dy = radiusM * Math.sin(angleRad); // ë‚¨ë¶ ë°©í–¥ (m)

      const baseLat = baseLatLng.getLat();
      const baseLng = baseLatLng.getLng();

      // ìœ„ë„ 1m â‰ˆ 1 / 111,320ë„
      const newLat = baseLat + (dy / 111320);

      // ê²½ë„ 1m â‰ˆ 1 / (111,320 * cos(lat))ë„
      const metersPerDegLng = 111320 * Math.cos(baseLat * Math.PI / 180);
      const newLng = baseLng + (dx / metersPerDegLng);

      return new kakao.maps.LatLng(newLat, newLng);
    }

    
    // ===== ì‚¬ì´ë“œ íŒ¨ë„ =====
    const sidePanel   = document.getElementById('sidePanel');
    const panelClose  = document.getElementById('panelClose');

    const pImg        = document.getElementById('pImg');
    const pTitle      = document.getElementById('pTitle');
    const pYearPlace  = document.getElementById('pYearPlace');
    const pPlace      = document.getElementById('pPlace');
    const pAddr       = document.getElementById('pAddr');
    const pName       = document.getElementById('pName');
    const pExp        = document.getElementById('pExp');
    const pRef        = document.getElementById('pRef');

    // â˜… ìƒˆë¡œ ì¶”ê°€
    const pAroundRow  = document.getElementById('pAroundRow');
    const nearAtList  = document.getElementById('nearAtList');
    const nearHoList  = document.getElementById('nearHoList');
    const nearFdList  = document.getElementById('nearFdList');


    // y1~y2 ë²”ìœ„ë¥¼ "1900â€“1912"ì²˜ëŸ¼ í‘œì‹œ, ì—†ìœ¼ë©´ DATA
    function formatYearRange(d){
      const a = d.y1;
      const b = d.y2;
      if (a && b && a !== b) return `${a}â€“${b}`;
      if (a) return String(a);
      if (b) return String(b);
      return d.DATA || d.data || '';
    }

    // function openInfoPanel(data, imageSrc){
    //   // ì´ë¯¸ì§€
    //   pImg.src = imageSrc || '';
    //   pImg.alt = data.TITLE_NM || data.title || '';

    //   // íƒ€ì´í‹€(ë“œë¼ë§ˆëª…)
    //   const titleText = data.TITLE_NM || data.title || '(ì œëª© ì—†ìŒ)';
    //   pTitle.textContent = titleText;

    //   // ìƒë‹¨ ì„œë¸Œë¼ì¸ = [ì—°ë„] Â· [ì¥ì†Œëª…]
    //   const yearText  = formatYearRange(data);
    //   const placeText = data.PLACE_NM || data.place || '';
    //   pYearPlace.textContent = [yearText, placeText].filter(Boolean).join(' Â· ');

    //   // ì¸ë¬¼ ì´ë¦„
    //   const whoName = data.NAME || data.name || '';

    //   // ê¸°ë³¸ ADDR (hist_points.json ìª½ ì£¼ì†Œ)
    //   const primaryAddr = data.ADDR || data.addr || '';

    //   // CSVì—ì„œ name ì¼ì¹˜í•˜ëŠ” adr
    //   const adrFromCSV = personAddrMap[whoName] || '';

    //   pAddr.textContent = primaryAddr || adrFromCSV || '';
      
    //   if (adrFromCSV && adrFromCSV !== whoName){
    //     pName.innerHTML = `
    //     <div>${whoName}</div>
    //     <div style="color:#9ca3af;font-size:12px;line-height:1.4;margin-top:4px;">
    //       ê´€ë ¨ ìƒì„¸ ë§í¬:
    //       <a href="${adrFromCSV}" target="_blank" rel="noopener noreferrer"
    //         style="color:#60a5fa; text-decoration:underline;">
    //         ${adrFromCSV}
    //       </a>
    //     </div>
    //     `;
    //   } else {
    //     pName.textContent = whoName || adrFromCSV || '';
    //   }

    //   // ë‚˜ë¨¸ì§€ í•„ë“œ
    //   pPlace.textContent = placeText;
    //   // pName.textContent  = whoName;
    //   pExp.textContent   = data.EXP || data.exp || '';
    //   pRef.textContent   = data.REF || data.ref || '';

    //   // íŒ¨ë„ ì—´ê¸°
    //   sidePanel.classList.add('open');
    // }


    async function openInfoPanel(data, imageSrc, latlngHint){
      // ì´ë¯¸ì§€
      pImg.src = imageSrc || '';
      pImg.alt = data.TITLE_NM || data.title || '';

      // íƒ€ì´í‹€(ì‘í’ˆ/ì¥ì†Œëª… ë“±)
      const titleText = data.TITLE_NM || data.title || '(ì œëª© ì—†ìŒ)';
      pTitle.textContent = titleText;

      // ìƒë‹¨ ì„œë¸Œë¼ì¸ = [ì—°ë„] Â· [ì¥ì†Œëª…]
      const yearText  = formatYearRange(data);
      const placeText = data.PLACE_NM || data.place || '';
      pYearPlace.textContent = [yearText, placeText].filter(Boolean).join(' Â· ');

      // ì¸ë¬¼ ì´ë¦„
      const whoName = data.NAME || data.name || '';

      // ì£¼ì†Œ (hist_points ìš°ì„ , ì—†ìœ¼ë©´ CSV adr)
      const primaryAddr = data.ADDR || data.addr || '';
      const adrFromCSV  = personAddrMap[whoName] || '';
      const finalAddr   = primaryAddr || adrFromCSV || '';
      pAddr.textContent = finalAddr;

      // ê´€ë ¨ ì •ë³´ (ì¸ë¬¼ + ë§í¬)
      if (adrFromCSV && adrFromCSV !== whoName){
        pName.innerHTML = `
          <div>${whoName}</div>
          <div style="color:#9ca3af;font-size:12px;line-height:1.4;margin-top:4px;">
            ê´€ë ¨ ìƒì„¸ ë§í¬:
            <a href="${adrFromCSV}" target="_blank" rel="noopener noreferrer"
              style="color:#60a5fa; text-decoration:underline;">
              ${adrFromCSV}
            </a>
          </div>
        `;
      } else {
        pName.textContent = whoName || adrFromCSV || '';
      }

      // ë‚˜ë¨¸ì§€ í•„ë“œ
      pPlace.textContent = placeText;
      pExp.textContent   = data.EXP || data.exp || '';
      pRef.textContent   = data.REF || data.ref || '';

      // íŒ¨ë„ ì—´ê¸°
      sidePanel.classList.add('open');

      // ì£¼ë³€ ê´€ê´‘/ìˆ™ë°•/ìŒì‹ + ì§€ë„ POI ë§ˆì»¤
      loadNearbyTourPreview(latlngHint, finalAddr);
    }

    function addPoiMarkers(list, kind){
      if (!list || !list.length) return;

      const iconSrcMap = {
        tour:  '/history/tour.png',
        hotel: '/history/hotel.png',
        food:  '/history/food.png'
      };
      const iconSrc = iconSrcMap[kind] || iconSrcMap.tour;

      list.forEach(poi => {
        if (!poi.lat || !poi.lng) return;

        // ê³ ìœ  ID ì—†ìœ¼ë©´ ë§Œë“¤ì–´ ë¶™ì—¬
        if (!poi.poiId) {
          poi.poiId = "poi_" + (poiIdCounter++);
        }
        poi.kind = kind;
        poiDataById[poi.poiId] = poi; // ì €ì¥

        const pos = new kakao.maps.LatLng(poi.lat, poi.lng);

        const markerImage = new kakao.maps.MarkerImage(
          iconSrc,
          new kakao.maps.Size(64, 64),
          { offset:new kakao.maps.Point(32, 64) }
        );

        const marker = new kakao.maps.Marker({
          position: pos,
          image: markerImage,
          clickable: true
        });

        marker.setMap(kmap);
        poiMarkers.push(marker);
        markerById[poi.poiId] = marker;

        kakao.maps.event.addListener(marker, 'click', function () {
          focusPoi(poi.poiId, {centerMap:true, openInfo:true, highlightList:true});
        });
      });
    }


    function renderNearbyPanel(tourList, hotelList, foodList){
      const wrap = document.getElementById('nearbyList');

      function makeItems(kind, arr){
        if (!arr || !arr.length) return '';

        return arr.slice(0,5).map(p => {
          // poiId ì£¼ì… (ì—†ìœ¼ë©´ ìƒˆë¡œ ë°°ì • â€” ë§ˆì»¤ë‘ ë™ì¼í•˜ê²Œ ë§ì¶°ì•¼ í•¨)
          if (!p.poiId) {
            p.poiId = "poi_" + (poiIdCounter++);
          }
          p.kind = kind;
          poiDataById[p.poiId] = p;

          const safeTitle = p.title || '(ì´ë¦„ì—†ìŒ)';
          const safeAddr  = p.addr  || '';

          return `
            <button class="near-item"
                    data-poiid="${p.poiId}"
                    style="
                      display:block;
                      text-align:left;
                      width:100%;
                      background:transparent;
                      border:0;
                      padding:6px 0;
                      color:#fff;
                      cursor:pointer;
                    ">
              <div style="font-weight:600;font-size:13px;line-height:1.4;">${safeTitle}</div>
              <div style="font-size:12px;line-height:1.4;color:#9ca3af;">${safeAddr}</div>
            </button>
          `;
        }).join('');
      }

      function sectionHtml(label, kind, arr){
        const itemsHtml = makeItems(kind, arr);
        if (!itemsHtml) return '';
        return `
          <div class="near-cat" style="margin-bottom:10px;">
            <div style="font-size:12px;font-weight:700;color:#60a5fa;margin-bottom:4px;">${label}</div>
            ${itemsHtml}
          </div>
        `;
      }

      wrap.innerHTML =
        sectionHtml('ê´€ê´‘ì§€', 'tour',  tourList) +
        sectionHtml('ìˆ™ì†Œ',   'hotel', hotelList) +
        sectionHtml('ìŒì‹',   'food',  foodList);

      if (wrap.innerHTML.trim() !== '') {
        document.getElementById('nearbyBlock').style.display = 'block';
      }

      // ë¦¬ìŠ¤íŠ¸ í´ë¦­ -> í•´ë‹¹ poië¡œ í¬ì»¤ìŠ¤
      wrap.addEventListener('click', (e) => {
        const btn = e.target.closest('.near-item');
        if (!btn) return;

        const poiId = btn.dataset.poiid;
        if (!poiId) return;

        focusPoi(poiId, {centerMap:true, openInfo:true, highlightList:true});
      }, { once:false });
    }

    function focusPoi(poiId, opts = {}){
      const { centerMap=true, openInfo=true, highlightList=true } = opts;

      const poi = poiDataById[poiId];
      const marker = markerById[poiId];
      if (!poi || !marker) return;

      const pos = new kakao.maps.LatLng(poi.lat, poi.lng);

      // 1) ì§€ë„ ì´ë™/ì¤Œ
      if (centerMap){
        kmap.setLevel(4);
        kmap.setCenter(pos);
      }

      // 2) ì¸í¬ìœˆë„ìš° (ê¸°ì¡´ ì—´ë ¤ìˆë˜ ê±° ë‹«ê³  ìƒˆë¡œ)
      if (openInfo){
        if (activeInfoWindow){
          activeInfoWindow.close();
        }
        const iwContent = `
          <div style="padding:6px 8px;font-size:12px;line-height:1.4;max-width:180px;">
            <div style="font-weight:600;margin-bottom:2px;">${poi.title || ''}</div>
            <div style="color:#555;">${poi.addr || ''}</div>
            ${poi.tel ? `<div style="color:#777;font-size:11px;margin-top:4px;">${poi.tel}</div>` : ''}
          </div>
        `;

        activeInfoWindow = new kakao.maps.InfoWindow({
          content: iwContent
        });
        activeInfoWindow.open(kmap, marker);
      }

      // 3) ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸
      // 3) ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸
      if (highlightList){
        const containers = [nearAtList, nearHoList, nearFdList].filter(Boolean);

        // ì´ì „ active ì œê±°
        if (activePoiId && activePoiId !== poiId){
          containers.forEach(c => {
            const prevEl = c.querySelector(`.near-item.active`);
            if (prevEl) prevEl.classList.remove('active');
          });
        }
        activePoiId = poiId;

        // ìƒˆ active ì¶”ê°€ + ìŠ¤í¬ë¡¤
        let curEl = null;
        for (const c of containers){
          const el = c.querySelector(`.near-item[data-poiid="${poiId}"]`);
          if (el){ curEl = el; break; }
        }
        if (curEl){
          curEl.classList.add('active');
          const scrollContainer = document.querySelector('.panel-scroll');
          if (scrollContainer){
            const boxTop   = curEl.getBoundingClientRect().top;
            const panelTop = scrollContainer.getBoundingClientRect().top;
            scrollContainer.scrollBy({ top: boxTop - panelTop - 40, behavior: 'smooth' });
          }
        }
      }

    }


    async function fetchNearby(latLng, kind){
      // kind: 'tour' | 'hotel' | 'food'

      // ì˜ˆì‹œ contentTypeId ë§¤í•‘ (í•œêµ­ê´€ê´‘ê³µì‚¬ TourAPI ê¸°ì¤€ ë§ì´ ì“°ëŠ” ê°’)
      const typeMap = {
        tour:  '12', // ê´€ê´‘ì§€
        hotel: '32', // ìˆ™ë°•
        food:  '39'  // ìŒì‹ì 
      };

      const contentTypeId = typeMap[kind];
      const radiusM = 500; // ë°˜ê²½ 500m ê°™ì€ê±°. ë„¤ê°€ ì“°ë˜ ê°’ì— ë§ì¶°

      const lat = latLng.getLat();
      const lng = latLng.getLng();

      // TODO: ì•„ë˜ URL, query stringì€ ì‹¤ì œ ë„ˆ app.jsì—ì„œ ì“°ë˜ê±° ë³µë¶™
      const url = `/tourapi/nearby?lat=${lat}&lng=${lng}&radius=${radiusM}&type=${contentTypeId}`;

      try{
        const resp = await fetch(url);
        const json = await resp.json();

        // ìš°ë¦¬ê°€ ì“¸ í˜•íƒœë¡œ ì •ê·œí™”: [{title, addr, lat, lng, tel, img}, ...]
        // app.jsì—ì„œ ì´ë¯¸ íŒŒì‹±í•˜ë˜ í˜•íƒœ ë”°ë¼ê°€ë©´ ë¼.
        return (json.items || []).map(item => ({
          title: item.title || item.place || '(ì´ë¦„ì—†ìŒ)',
          addr:  item.addr  || item.address || '',
          lat:   item.mapy || item.lat,
          lng:   item.mapx || item.lng,
          tel:   item.tel   || '',
          img:   item.firstimage || ''
        }));
      } catch(e){
        console.warn('fetchNearby fail', kind, e);
        return [];
      }
    }


    panelClose.addEventListener('click', () => {
      sidePanel.classList.remove('open');
    });

    /* 7) ì—°ëŒ€í‘œ ë Œë”ë§/í† ê¸€ + í´ë¦­/ë“œë˜ê·¸ ì»¤ì„œ */
    const fabTimeline   = document.getElementById('fabTimeline');
    const panelTimeline = document.getElementById('timelinePanel');
    const bar           = document.getElementById('timelineBar');
    const ticks         = document.getElementById('timelineTicks');
    const tip           = document.getElementById('timelineTip');
    const closeBtn      = document.getElementById('closeTimeline');

    // ì»¤ì„œ DOM
    const yearCursor = document.createElement('div'); yearCursor.className = 'year-cursor';
    const yearBadge  = document.createElement('div'); yearBadge.className  = 'year-badge';
    const yearHandle = document.createElement('div'); yearHandle.className = 'year-handle';
    const yearHandleTxt = document.createElement('div'); yearHandleTxt.className='txt';
    yearHandle.appendChild(yearHandleTxt);

    function yearToPercent(y){ return ((y - TL_START) / TL_SPAN) * 100; }
    function percentToYear(p){ return Math.round(TL_START + TL_SPAN * (p/100)); }

    function showYearCursorAt(year){
      const p = yearToPercent(year);
      yearCursor.style.left = `calc(${p}% - 1px)`;
      yearCursor.style.display = 'block';
      yearBadge.style.left  = `${p}%`;
      yearBadge.textContent = String(year);
      yearBadge.style.display = 'block';
      yearHandle.style.left = `${p}%`;
      yearHandleTxt.textContent = String(year);
      yearHandle.style.display = 'flex';
    }
    function hideYearCursor(){
      yearCursor.style.display = 'none';
      yearBadge .style.display = 'none';
      yearHandle.style.display = 'none';
    }

    function chooseLayerByYear(y){
      if (y < 1940) {
        setYear('1919');
      } else if (y >= 1965 && y <= 1979) {
        setYear('1970');
      }
      // ê·¸ ì™¸ëŠ” ìœ ì§€
    }

    function placeYearCursor(year){
      year = Math.max(TL_START, Math.min(TL_END, year|0));
      showYearCursorAt(year);
      chooseLayerByYear(year);
      showPinsForYear(year); // í•´ë‹¹ ì—°ë„ ë§ˆì»¤ í‘œì‹œ
    }

    // ë“œë˜ê·¸ ì§€ì›
    let dragging = false;
    function pxToYear(clientX){
      const rect = bar.getBoundingClientRect();
      const px   = Math.max(0, Math.min(rect.width, clientX - rect.left));
      const p    = (px/rect.width)*100;
      return percentToYear(p);
    }
    bar.addEventListener('mousedown', (e) => {
      dragging = true;
      placeYearCursor(pxToYear(e.clientX));
      e.preventDefault();
    });
    window.addEventListener('mousemove', (e) => {
      if (dragging) placeYearCursor(pxToYear(e.clientX));
    });
    window.addEventListener('mouseup',   ()  => { dragging = false; });

    // ëˆˆê¸ˆ ë¼ë²¨ í´ë¦­
    ticks.addEventListener('click', (e) => {
      if (e.target.classList.contains('tick-label')) {
        placeYearCursor(parseInt(e.target.textContent, 10));
      }
    });

    function renderTimeline(){
      bar.innerHTML = '';
      ticks.innerHTML = '';

      // êµ¬ê°„ ë¸”ë¡
      PERIODS.forEach(p => {
        const l = Math.max(TL_START, p.start);
        const r = Math.min(TL_END,   p.end);
        const left  = yearToPercent(l);
        const right = yearToPercent(r);
        const width = Math.max(0, right - left);

        const el = document.createElement('div');
        el.className = 'period';
        el.style.left  = left + '%';
        el.style.width = width + '%';
        el.style.background = p.color;
        el.innerHTML = `<span>${p.label}</span>`;
        el.dataset.label = p.label;
        el.dataset.range = `${p.start}â€“${p.end === NOW_YEAR ? 'í˜„ì¬' : p.end}`;
        el.addEventListener('mousemove', (e) => {
          tip.style.display = 'block';
          tip.style.left = (e.clientX - panelTimeline.getBoundingClientRect().left) + 'px';
          tip.style.top  = (bar.getBoundingClientRect().top - panelTimeline.getBoundingClientRect().top) + 'px';
          tip.textContent = `${el.dataset.label} (${el.dataset.range})`;
        });
        el.addEventListener('mouseleave', () => tip.style.display = 'none');
        bar.appendChild(el);
      });

      // 50ë…„ ê°„ê²© ëˆˆê¸ˆ
      const step = 50;
      for (let y = Math.ceil(TL_START/step)*step; y <= TL_END; y += step){
        const x = yearToPercent(y);
        const t = document.createElement('div');
        t.className = 'tick'; t.style.left = x + '%';
        ticks.appendChild(t);

        const lab = document.createElement('div');
        lab.className = 'tick-label'; lab.style.left = x + '%'; lab.textContent = String(y);
        lab.addEventListener('click', () => placeYearCursor(y));
        ticks.appendChild(lab);
      }

      // ì»¤ì„œ DOM ë§ˆì§€ë§‰ì— ë¶€ì°©
      bar.appendChild(yearHandle);
      bar.appendChild(yearCursor);
      bar.appendChild(yearBadge);
      hideYearCursor();
    }

    // ë¼ë²¨ ë„ˆë¹„ì— ë§ê²Œ ì¤„ì´ê¸°
    function shrinkRepublicLabel(txt){
      return txt
        .replace(/^ëŒ€í•œë¯¼êµ­\s*/g, '')
        .replace(/^ì œ(\d)ê³µí™”êµ­$/, 'ì œ$1ê³µí™”êµ­')
        .replace(/^ì œ(\d)ê³µí™”êµ­$/, '$1ê³µí™”êµ­')
        .replace(/^(\d)ê³µí™”êµ­$/, '$1ê³µ');
    }
    function fitPeriodLabels(){
      document.querySelectorAll('.period').forEach(el => {
        const span = el.querySelector('span'); if (!span) return;
        const original = span.getAttribute('data-original') || span.textContent;
        span.setAttribute('data-original', original);
        let text = original;
        const boxWidth = el.getBoundingClientRect().width;
        span.textContent = text;
        const need = () => span.scrollWidth > boxWidth - 12;
        if (need()){ text = shrinkRepublicLabel(original); span.textContent = text; }
        if (need()){ text = shrinkRepublicLabel(text);     span.textContent = text; }
        if (need()){ text = shrinkRepublicLabel(text);     span.textContent = text; }
        let fs = parseFloat(getComputedStyle(el).fontSize) || 15;
        while (need() && fs > 11){
          fs -= 0.5;
          el.style.fontSize = fs + 'px';
        }
        el.title = original;
      });
    }

    // ì—°ëŒ€í‘œ íŒ¨ë„ í† ê¸€
    function openTimeline(){ panelTimeline.style.display = 'block'; }
    function closeTimeline(){ panelTimeline.style.display = 'none';  }
    fabTimeline.addEventListener('click', () => {
      const show = panelTimeline.style.display !== 'block';
      if (show) openTimeline(); else closeTimeline();
    });
    closeBtn.addEventListener('click', closeTimeline);

    renderTimeline();
    fitPeriodLabels();

    window.addEventListener('resize', () => {
      fitPeriodLabels();
    });

    // ====== ì´ˆê¸° ë¡œë”© ìˆœì„œ ======
    (async () => {
      // 1. hist_points.json ë¡œë“œ
      await loadHistPoints();
      // 2. history_data.csv ë¡œë“œí•´ì„œ personAddrMap êµ¬ì„±
      await loadPersonAddrCSV();
      // 3. ì´ˆê¸° ì—°ë„(ì˜ˆ: 1919ë…„) ê¸°ì¤€ìœ¼ë¡œ ë§ˆì»¤ ê·¸ë¦¬ê¸°
      placeYearCursor(1919);
    })();

  });
});
</script>
</body>
</html>
